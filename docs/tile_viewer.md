# Tile Viewer

`tile_viewer.py` is an advanced Python application for visualizing map tiles, supporting both custom vector tiles in `.bin` format and raster tiles in `.png` format.  
It provides an interactive map viewer with mouse and keyboard controls, allowing exploration of tiles rendered in either format.

## Features

- **High Performance**: LRU cache system with configurable memory limits
- **Multi-threading**: Persistent thread pool for efficient tile loading
- **Error Recovery**: Graceful handling of missing or corrupted tiles
- **Lazy Loading**: Only loads visible tiles to optimize memory usage
- **Advanced Rendering**: Supports advanced compression commands (GRID_PATTERN, CIRCLE, PREDICTED_LINE, DASHED_LINE, DOTTED_LINE)
- **Dynamic Palette**: Loads color palettes from binary files (`palette.bin`) or configuration files (`features.json`)
- **Modern UI**: Beautiful icons and improved button text rendering
- **Layer Support**: Renders tiles in correct layer order (TERRAIN, WATER, BUILDINGS, OUTLINES, ROADS, LABELS)
- **Polygon Filling**: Toggle between filled and outlined polygon rendering

---

## What Does This Script Do?

- Loads and renders tiles from a directory containing tiles in `.bin` (vector) **or** `.png` (raster) format
- Supports multiple zoom levels and smooth panning
- Displays tile boundaries, coordinates, and labels
- Offers interactive controls via mouse and keyboard
- Can show GPS cursor coordinates and fill polygons in vector tiles
- Implements intelligent caching and memory management
- Provides detailed logging and error reporting
- Loads dynamic color palettes for accurate tile rendering

**Note:** If both `.bin` and `.png` files are present for a tile, `.bin` is preferred and rendered as vector graphics.  
This script is useful for visualizing both the output of the vector tile generator and other map tiles in PNG format.

---

## Directory Structure

The tile viewer expects the following directory structure:

```
TILES_DIRECTORY/
├── 6/                    # Zoom level 6
│   ├── 0/               # Tile X coordinate
│   │   ├── 0.bin        # Vector tile (preferred)
│   │   └── 0.png        # Raster tile (fallback)
│   ├── 1/
│   │   ├── 0.bin
│   │   └── 0.png
│   └── ...
├── 7/                    # Zoom level 7
│   ├── 0/
│   │   ├── 0.bin
│   │   └── 0.png
│   └── ...
├── 8/                    # Zoom level 8
├── ...
└── palette.bin           # Binary color palette (optional, preferred)

features.json             # Feature configuration (optional, fallback) - in script directory
```

### Tile File Formats

- **`.bin` files**: Custom vector tile format with compressed drawing commands
- **`.png` files**: Standard raster tile format (fallback)
- **`palette.bin`**: Binary color palette file generated by `tile_generator.py` (in tile directory)
- **`features.json`**: JSON configuration file with feature definitions and colors (in script directory)

---

## Dependencies

### Python Packages

You need the following Python packages:

- `pygame` - Graphics and window management
- `struct` - Binary data handling (built-in)
- `threading` - Multi-threading support (built-in)
- `concurrent.futures` - Thread pool management (built-in)
- `collections` - Data structures (built-in)
- `functools` - Function utilities (built-in)

### System Dependencies

For optimal performance, you may also need:

- `python3-dev` - Python development headers
- `libsdl2-dev` - SDL2 development libraries (for pygame)

### Installation

#### Using pip (Python packages):

```sh
pip install pygame
```

#### Using apt (System packages):

```sh
# Ubuntu/Debian
sudo apt update
sudo apt install python3-pygame python3-dev libsdl2-dev

# Or install pygame system-wide
sudo apt install python3-pygame
```

#### Complete installation script:

```sh
# Update package list
sudo apt update

# Install system dependencies
sudo apt install python3 python3-pip python3-dev libsdl2-dev

# Install Python packages
pip3 install pygame

# Verify installation
python3 -c "import pygame; print('Pygame version:', pygame.version.ver)"
```

---

## How It Works

### Controls

- **Mouse Drag:** Pan the viewport across the map
- **Mouse Wheel / `[ ]` keys:** Zoom in and out between available zoom levels
- **Arrow Keys:** Move viewport left, right, up, or down
- **Buttons (on the right toolbar):**
    - **Background:** Toggle background color (black/white)
    - **Tile Labels:** Show/hide tile coordinates and file names
    - **GPS Cursor:** Show/hide cursor latitude/longitude (in decimal and GMS)
    - **Fill Polygons:** Toggle filled polygons rendering (for vector `.bin` tiles)
- **`l` key:** Toggle tile labels
- **`f` key:** Toggle polygon filling
- **Toolbar buttons:** Click to activate features with improved multi-line text rendering

### Status Bar

- Shows the current zoom level and progress bars for indexing/loading tiles
- Displays cache statistics and performance metrics
- Real-time logging of operations and errors

### Startup

Start the script with the tile directory as argument:

```sh
python3 tile_viewer.py TILES_DIRECTORY
```

---

## Configuration

The viewer uses hardcoded default configuration values. All viewer-specific settings are built into the application:

### Default Configuration

```python
DEFAULT_CONFIG = {
    'tile_size': 256,
    'viewport_size': 768,
    'toolbar_width': 160,
    'statusbar_height': 40,
    'max_cache_size': 1000,
    'thread_pool_size': 4,
    'background_colors': [(0, 0, 0), (255, 255, 255)],
    'log_level': 'INFO',
    'config_file': 'features.json',
    'fps_limit': 30,
    'fill_polygons': False
}
```

### Configuration Options

- `tile_size`: Size of individual tiles in pixels (default: 256)
- `viewport_size`: Size of the viewport window (default: 768)
- `toolbar_width`: Width of the right toolbar in pixels (default: 160)
- `statusbar_height`: Height of the status bar in pixels (default: 40)
- `max_cache_size`: Maximum number of tiles to cache (default: 1000)
- `thread_pool_size`: Number of worker threads for tile loading (default: 4)
- `background_colors`: Array of background colors for toggle (default: black and white)
- `log_level`: Logging level (default: "INFO")
- `fps_limit`: Maximum frames per second (default: 30)
- `fill_polygons`: Whether to fill polygons by default (default: False)

**Note:** All configuration values are hardcoded for optimal performance and consistency.

---

## Palette Loading

The viewer supports two methods for loading color palettes:

### 1. Binary Palette (Preferred)

The viewer automatically looks for `palette.bin` in the tile directory:

```sh
# Generated by tile_generator.py in the tile directory
TILES_DIRECTORY/
├── 6/
├── 7/
├── ...
└── palette.bin
```

**Format:** 4-byte header (number of colors) + RGB888 color data (3 bytes per color)

### 2. JSON Configuration (Fallback)

If `palette.bin` is not found, the viewer falls back to `features.json` for color extraction:

The viewer extracts unique colors from feature definitions in `features.json` to build the palette dynamically.

---

## Performance Features

- **LRU Cache**: Intelligent memory management with configurable limits
- **Thread Pool**: Persistent worker threads for efficient tile loading
- **Lazy Loading**: Only loads visible tiles to optimize memory usage
- **Coordinate Caching**: Cached coordinate conversions for better performance
- **Error Recovery**: Graceful handling of missing or corrupted tiles
- **Memory Pool**: Reusable objects to reduce garbage collection
- **Streaming**: Processes tiles in batches to reduce memory footprint

---

## Supported Drawing Commands

The viewer supports a wide range of drawing commands for vector tiles:

### Basic Commands
- `LINE` (1): Draw a line between two points
- `POLYLINE` (2): Draw a polyline with multiple points
- `STROKE_POLYGON` (3): Draw a polygon outline
- `HORIZONTAL_LINE` (5): Draw a horizontal line
- `VERTICAL_LINE` (6): Draw a vertical line

### Advanced Commands
- `RECTANGLE` (0x82): Draw a rectangle
- `STRAIGHT_LINE` (0x83): Draw a straight line
- `HIGHWAY_SEGMENT` (0x84): Draw highway segments
- `GRID_PATTERN` (0x85): Draw grid patterns
- `BLOCK_PATTERN` (0x86): Draw city block patterns
- `CIRCLE` (0x87): Draw circles
- `PREDICTED_LINE` (0x8A): Draw predicted lines
- `COMPRESSED_POLYLINE` (0x8B): Draw compressed polylines
- `OPTIMIZED_POLYGON` (0x8C): Draw optimized polygons
- `HOLLOW_POLYGON` (0x8D): Draw hollow polygons
- `OPTIMIZED_TRIANGLE` (0x8E): Draw optimized triangles
- `OPTIMIZED_RECTANGLE` (0x8F): Draw optimized rectangles
- `OPTIMIZED_CIRCLE` (0x90): Draw optimized circles
- `SIMPLE_RECTANGLE` (0x96): Draw simple rectangles
- `SIMPLE_CIRCLE` (0x97): Draw simple circles
- `SIMPLE_TRIANGLE` (0x98): Draw simple triangles
- `DASHED_LINE` (0x99): Draw dashed lines
- `DOTTED_LINE` (0x9A): Draw dotted lines

### State Commands
- `SET_COLOR` (0x80): Set direct RGB332 color
- `SET_COLOR_INDEX` (0x81): Set color from palette index
- `SET_LAYER` (0x88): Set rendering layer
- `RELATIVE_MOVE` (0x89): Move cursor relatively

---

## Rendering Layers

Tiles are rendered in the following layer order (from bottom to top):

1. **TERRAIN** (0): Background terrain, water bodies
2. **WATER** (1): Rivers, lakes, oceans
3. **BUILDINGS** (2): Buildings, structures
4. **OUTLINES** (3): Polygon outlines, borders
5. **ROADS** (4): Roads, highways, paths
6. **LABELS** (5): Text labels, symbols

---

## Troubleshooting

### Common Issues

1. **"No zoom level directories found"**
   - Ensure your tile directory contains subdirectories named with numbers (6, 7, 8, etc.)
   - Check that the directory path is correct

2. **"Could not load palette from palette.bin"**
   - The viewer will fall back to `features.json`
   - Ensure `palette.bin` was generated by `tile_generator.py`

3. **"Tile file does not exist"**
   - Check that tile files exist in the expected `{zoom}/{x}/{y}.bin` or `.png` format
   - Verify file permissions

4. **Performance Issues**
   - Reduce `max_cache_size` in configuration
   - Lower `thread_pool_size` for systems with limited cores
   - Check available system memory

### Debug Mode

Enable debug logging by modifying the configuration:

```python
# In tile_viewer.py, change:
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
```

---

## Notes

- If the tile directory contains both `.bin` and `.png` files, `.bin` is preferred for vector rendering
- The viewer supports multiple zoom levels, switching seamlessly with mouse wheel or bracket keys
- The GPS tooltip shows coordinates at the mouse position, both in decimal degrees and degrees/minutes/seconds (GMS)
- You can visualize both vector tiles (`.bin`) and raster tiles (`.png`) in the same directory
- The application includes comprehensive logging for debugging and monitoring
- Modern UI with beautiful icons and improved text rendering
- Polygon filling can be toggled on/off for different visualization needs
- The viewer automatically handles tile borders and interior segments differently for better visual quality

---

## Integration with Tile Generator

This viewer is designed to work seamlessly with `tile_generator.py`:

1. **Generate tiles**: Run `tile_generator.py` to create `.bin` tiles and `palette.bin`
2. **View tiles**: Run `tile_viewer.py` to visualize the generated tiles
3. **Automatic palette**: The viewer automatically loads the correct color palette from `palette.bin`
4. **Layer support**: All rendering layers are properly supported
5. **Command compatibility**: All drawing commands are fully supported

The viewer provides an excellent way to preview and debug tiles generated by the tile generator.